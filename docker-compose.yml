version: '3.8'

services:
  api:
    build: ./api
    container_name: deepsafe-api
    ports:
      - "8000:8000"
    restart: unless-stopped
    volumes:
      - ./api/meta_model_artifacts:/app/meta_model_artifacts:ro
      - ./config/deepsafe_config.json:/app/config/deepsafe_config.json:ro
    environment:
      - PORT=8000
      - META_MODEL_ARTIFACTS_DIR=/app/meta_model_artifacts
      - DEEPSAFE_CONFIG_FILE_PATH=/app/config/deepsafe_config.json
      # - LOG_LEVEL=debug # Optional: for more verbose API logs
    depends_on:
      - npr_deepfakedetection
      - universalfakedetect
      # Add other future video/audio model service names here
    networks:
      - deepsafe-network

  # --- Image Model Services ---
  npr_deepfakedetection:
    build: ./models/image/npr_deepfakedetection
    container_name: deepsafe-npr_deepfakedetection
    ports:
      - "5001:5001"
    restart: unless-stopped
    environment:
      - MODEL_PORT=5001
      - PRELOAD_MODEL=false
      - MODEL_TIMEOUT=600
      - USE_GPU=false
    networks:
      - deepsafe-network

  # yermandy_clip_detection:
  #   build: ./models/image/yermandy_clip_detection
  #   container_name: deepsafe-yermandy-clip-detection
  #   ports:
  #     - "5002:5002"
  #   restart: unless-stopped
  #   environment:
  #     - MODEL_PORT=5002
  #     - MODEL_PATH=model_code/weights/model.ckpt
  #     - PRELOAD_MODEL=false
  #     - MODEL_TIMEOUT=600
  #     - USE_GPU=false
  #   networks:
  #     - deepsafe-network

  # wavelet_clip_detection:
  #   build: ./models/image/wavelet_clip_detection
  #   container_name: deepsafe-wavelet-clip-detection
  #   ports:
  #     - "5003:5003"
  #   restart: unless-stopped
  #   environment:
  #     - MODEL_PORT=5003
  #     - MODEL_PATH=model_code/weights/clip_wavelet_best.pth
  #     - PRELOAD_MODEL=false
  #     - MODEL_TIMEOUT=600
  #     - USE_GPU=false
  #   networks:
  #     - deepsafe-network

  universalfakedetect:
    build: ./models/image/universalfakedetect
    container_name: deepsafe-universalfakedetect
    ports:
      - "5004:5004"
    restart: unless-stopped
    environment:
      - MODEL_PORT=5004
      - PRELOAD_MODEL=false
      - MODEL_TIMEOUT=600
      - USE_GPU=false
    networks:
      - deepsafe-network

  # trufor:
  #   build: ./models/image/trufor
  #   container_name: deepsafe-trufor
  #   ports:
  #     - "5005:5005"
  #   restart: unless-stopped
  #   environment:
  #     - MODEL_PORT=5005
  #     - PRELOAD_MODEL=false
  #     - MODEL_TIMEOUT=600
  #     - USE_GPU=false
  #   networks:
  #     - deepsafe-network

  # spsl_deepfake_detection:
  #   build: ./models/image/spsl_deepfake_detection
  #   container_name: deepsafe-spsl-deepfake-detection
  #   ports:
  #     - "5006:5006"
  #   restart: unless-stopped
  #   environment:
  #     - MODEL_PORT=5006
  #     - PRELOAD_MODEL=false
  #     - MODEL_TIMEOUT=600
  #     - USE_GPU=false
  #   networks:
  #     - deepsafe-network

  # ucf_deepfake_detection:
  #   build: ./models/image/ucf_deepfake_detection
  #   container_name: deepsafe-ucf-deepfake-detection
  #   ports:
  #     - "5007:5007"
  #   restart: unless-stopped
  #   environment:
  #     - MODEL_PORT=5007
  #     - PRELOAD_MODEL=false
  #     - MODEL_TIMEOUT=600
  #     - USE_GPU=false
  #   networks:
  #     - deepsafe-network

  cross_efficient_vit:
    build: ./models/video/cross_efficient_vit
    container_name: deepsafe-cross-efficient-vit
    ports:
      - "7001:7001"
    restart: unless-stopped
    environment:
      - MODEL_PORT=7001
      - PRELOAD_MODEL=false 
      - MODEL_TIMEOUT=900   # Video models might be heavier, allow longer idle time
      - USE_GPU=false       # Ensure CPU operation
      # The following are set within the cross_efficient_vit/Dockerfile,
      # but can be overridden here if needed for different weight files for the same image:
      # - DEFAULT_MODEL_VARIANT="cross_efficient_vit" 
      # - CROSS_EFFICIENT_VIT_MODEL_PATH="/app/model_code/cross-efficient-vit/pretrained_models/cross_efficient_vit.pth"
      # - EFFICIENT_VIT_MODEL_PATH="/app/model_code/efficient-vit/pretrained_models/efficient_vit.pth"
      # - CROSS_EFFICIENT_VIT_CONFIG_PATH="/app/model_code/cross-efficient-vit/configs/architecture.yaml"
      # - EFFICIENT_VIT_CONFIG_PATH="/app/model_code/efficient-vit/configs/architecture.yaml"
      # - FRAMES_PER_VIDEO="15" # If you want to control frame sampling from docker-compose
    networks:
      - deepsafe-network
    # Optional: Add resource limits for CPU/memory if this model is resource-intensive
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0' 
    #       memory: 4G

  # --- Placeholder for future audio model service ---
  # example_audio_model_1:
  #   build: ./models/audio/example_audio_model_1
  #   container_name: deepsafe-example-audio-model-1
  #   ports:
  #     - "8001:8001"
  #   restart: unless-stopped
  #   # ... environment ...
  #   networks:
  #     - deepsafe-network

  frontend:
    build: ./frontend
    container_name: deepsafe-frontend
    ports:
      - "8888:80"
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - deepsafe-network

networks:
  deepsafe-network:
    driver: bridge